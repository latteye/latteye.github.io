<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Linksys WAG 354G System · Water is</title><meta name="description" content="Linksys WAG 354G System - latteye"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://latteye.me/atom.xml" title="Water is"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://www.zhihu.com/people/yuan-hao-yang" target="_blank" class="nav-list-link">ZHIHU</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">Linksys WAG 354G System</h1><div class="post-info">2008年6月5日</div><div class="post-content"><p>很长时间不写日志了，这次来个重量级的。<br>本文竭尽全力提供 Linksys WAG 354G ADSL+Wireless Route 的高级定制。<br><a id="more"></a></p>
<p><strong>一、硬件</strong></p>
<p><img src="http://www.pc-pda.com/gallery/albums/Shen/0727/linksys/BigBull_91010108_2.JPG" alt="354G"><br>此图为 V2 简装版，其实就是国外不用的板子，再上个壳子。</p>
<p>这是一款整合了 ADSL 猫的无线路由器。最大无线传输速率为125M，有线连接速率为 100M。其 CPU 为Texas Instruments AR7  210M V2版本(V1 版本为 150M CPU)，Flash 为 4M，内存为 16 M。</p>
<p>硬件参数不是特别高，我的目的是整合那一大堆的 Modem， Route。所以挑选了这款设备。<br>默认 IP 为 192.168.1.1，子网掩码 255.255.255.0 ，用户名密码：admin。</p>
<p><strong>二、Linksys 系统</strong></p>
<p>Linksys 默认提供的系统功能有限，随便给一个<a href="http://auction1.taobao.com/auction/item_detail-0db2-76d300b6438d582582d19961341eef94.jhtml" target="_blank" rel="external">淘宝上的卖家链接</a>，此为 V1 版本，但系统是一样的。通过截图就可以看到，功能很有限。</p>
<p>于是就开始了漫长的寻找系统之路………..</p>
<p><strong>三、Neptune354</strong></p>
<p>Neptune354 是国外 <a href="http://cyberstorm.altervista.org/blog/?page_id=24" target="_blank" rel="external">marco v</a> 制作的版本。貌似他的基础是 linksys 提供的源码。</p>
<p>功能简介：<br>1. 有 http 页面控制，比较傻瓜化。<br>2. 有 SSH<br>3. 支持 <a href="http://www.nslu2-linux.org/wiki/Optware/Packages" target="_blank" rel="external">OptWare 的软件包</a>。<br>4. 双 PPPoE 拨号<br>5. 支持 WAP-PSK 认证<br>6. 支持 SNMP<br>7. 可挂在 NFS 文件系统。<br>8. 用户可写空间为 120k 左右。</p>
<p>更多的大家可以在<a href="http://cyberstorm.altervista.org/?p=31" target="_blank" rel="external">他的主页</a>上看到。</p>
<p>请注意，国内出售的一般都是 Annex A 版本。如果你是 V2 版本，移步至 Jim 的<a href="http://wiki.techesolution.com/" target="_blank" rel="external">项目页面</a>下载。</p>
<p>对应的文件为： <a href="http://wiki.techesolution.com/neptune354/neptune354_0.2_v2_AnnexA_upgrade_code.bin" target="_blank" rel="external">http://wiki.techesolution.com/neptune354/neptune354_0.2_v2_AnnexA_upgrade_code.bin</a></p>
<p>这里有人要问什么是 Annex A？什么是 Annex B？<br>Annex A ：国内用的都是这个了，貌似是 POTS？不是很确定。<br>Annex B：似乎只有德国还在用这个。基于 ISDN 的 ADSL。 ISDN 在90年代末期听说过，当时南方城市推广的“一线通”就是这个东西吧。</p>
<p>所以，我们一定要下载 Annex A。</p>
<p><strong>四、错误处理</strong></p>
<p>刷错固件是常有的事情，如果你刷了 marco v 提供的 <a href="http://www.webalice.it/markvd/openwrt/" target="_blank" rel="external">openwrt 版本</a>，就可能会挂掉。具体症状为：刷机之后，电源等出现单纯的红灯闪烁。<br>这个时候系统就肯定是挂掉了。不用担心，救的回来。</p>
<p>先来看看 <a href="http://wiki.openwrt.org/OpenWrtDocs/Customizing/Firmware/PSPBoot?action=show&amp;redirect=PSPBoot" target="_blank" rel="external">PSPBoot</a>，因为 354G 用的就是这一款引导 rom。你刷系统的时候是不会影响到 Boot Loader 的。</p>
<p>有详细的 <a href="http://wiki.openwrt.org/OpenWrtDocs/Customizing/Firmware/PSPBoot?action=AttachFile&amp;do=get&amp;target=PSPBoot_User_Guide.pdf" target="_blank" rel="external">PDF 文档</a>。</p>
<p>这款引导rom，内置了 tftp 程序。在引导阶段，将合适的 bin 推到引导 rom 里面。他会自动将新的bin文件刷进 Flash 中。</p>
<p>具体操作：（最好是使用 Linux 系统，Linksys 提供的 tftp 小程序也可以）</p>
<blockquote>
<p>tftp</p>
<p>tftp&gt;binary</p>
<p>tftp&gt;trace</p>
<p>tftp&gt;verbose</p>
<p>tftp&gt;connect 192.168.1.1</p>
</blockquote>
<p>##注意，bootloader 的程序一定是 192.168.1.1 地址，你必须将客户机设置为与其同网段。这个IP应该和 route 设置的 ip 没有关系。</p>
<p><code>tftp&gt;put upgrade_code.bin</code></p>
<blockquote>
<p>请将你需要刷的bin包改名为 upgrade_code.bin ，在打完 put upgrade_code.bin 命令之后不要按回车！！此时可以将路由器电源拔下。再插上，你会看到路由器4个 LAN 灯同时闪一下，接着熄灭。再紧接着，插了网线的 LAN 口灯就亮起了！就是现在！按下回车键，upgrade_code.bin 就会被传送上去了。</p>
<p>建议：不要将路由器和电脑直接连接，因为某些网卡反应很慢，在路由器网卡已经准备好的时候，电脑网卡还没起来。你需要在电脑和路由器直接加一个交换机，并让交换机时刻保持开启状态。</p>
<p>注意：引导rom是存在 192.168.1.1 这个地址的。但你无法ping到它。</p>
<p>bin 包传送完成之后，电源灯有一段时间闪烁状态（绿灯慢闪），这个时候也不要尝试 ping 它。它正在准备系统。</p>
</blockquote>
<p><strong>五、OpenWRT</strong></p>
<p>Neptune354 提供的包，可以用。易用性也还不错。如果你对网络环境要求不高，用那个就可以了。<br>但是对我，还缺少了一个最重要的 PPTP 功能。多方搜索之后决定自己打包一个 openwrt。上面已经说过了 marco v 提供的 openwrt 包刷了系统就挂了，大家不用尝试了。</p>
<p>自己编译 openwrt 并不是很复杂的事情，推荐大家使用 Ubuntu 和 Debian。虽然我本人用 Arch 作为桌面系统。但在编译的时候也还是很趋向于 Debian 的，为啥？包多啊，方便。不用到处找。</p>
<p>1. check out 源码</p>
<p><code>svn co https://svn.openwrt.org/openwrt/trunk</code></p>
<p>当完成 check out 之后，你需要通过 make menuconfig 命令来定制需要的功能。</p>
<p>2. 功能选择</p>
<p>这里只给出必须的选项，很多软件包请用户自己根据需要添加。</p>
<p><code>make menuconfig</code></p>
<p>(1) Target System -&gt; TI AR7 [2.6]</p>
<p><img src="http://latteye.com/wp-content/images/openwrt/openwrt-1.jpg" alt=""></p>
<p>(2) Target Images -&gt; SquashFS</p>
<p>我们只需要 SquashFS 就够了。</p>
<p><img src="http://latteye.com/wp-content/images/openwrt/openwrt-2.jpg" alt=""> </p>
<p>（3）Base system -&gt; br2684ctl</p>
<p>如果你不选这个选项，就没有 nas 设备了，而 nas 设备是 pppoe 需要用到的。</p>
<p><img src="http://latteye.com/wp-content/images/openwrt/openwrt-3.jpg" alt=""></p>
<p>（4）Network -&gt; ppp -&gt; ppp-mod-pppoe</p>
<p>pppoe 自然是要选的，就不多解释了。</p>
<p>（5）Kernel Modules -&gt; Network Devices -&gt; annex A</p>
<p>前面已经讨论过 Annex A 了。</p>
<p>3. 编译</p>
<p>命令</p>
<p><code>make</code></p>
<p>就会开始编译了，由于编译的过程会从网上下载源码包，所以整个过程可能时间很长。在我编译的时候，下载的源码总大小为 141M。默认使用 wget 来下载。如果你觉得比较慢，可以通过命令 ：</p>
<p><code>make V=99</code></p>
<p>来详细的查看编译的过程，当看到需要下载的源码时，可以手动将文件下载到 trunk/dl 目录下面。这样 make 程序会跳过下载，确定 md5sum 没问题就会直接编译软件包。</p>
<p>整个编译过程很自动化，一般不需要人为干涉。</p>
<p>在编译完成之后，可以在 trunk/bin 下面找到需要的 fireware 文件。<br>奇怪的是，很多文章都说要刷的是 ：openwrt-ar7-squashfs.bin 文件。但实际上这个文件刷不进去，会报不匹配错误。<br>而能刷入的是 ： openwrt-WA7A-squashfs.bin （For V2） 文件。<br>尽管很奇怪，但 WA7A 的确可以很好的工作。</p>
<p>这里附上我自己编译的 <a href="http://www.fs2you.com/files/2ef18923-3316-11dd-b2d0-0014221f4662/" target="_blank" rel="external">openwrt-WA7A-squashfs.bin</a> 文件供大家试用。请注意！我不提供任何担保！即使你的路由器在刷了这个bin之后变成了变形金刚，我也是不负责的:)</p>
<p>4. openwrt 的试用</p>
<p>（1） 登录</p>
<p>在没有设置用户名，密码时，可以通过 telnet 登录。</p>
<p><code>telnet 192.168.1.1</code></p>
<p>当你通过了 passwd 设置root用户密码之后，ssh 服务器会自动开启。</p>
<p><code>ssh -l root 192.168.1.1</code></p>
<p>(2) 检查硬件环境<br>最重要的是检查 ATM 模块是否被驱动了：</p>
<blockquote>
<p>root@OpenWrt:~# dmesg | grep ATM</p>
<p>Texas Instruments ATM driver: version:[7.03.01.00]</p>
</blockquote>
<p>正常的信息应该类似这样，驱动 7.03.01.00 已经被加载了。</p>
<p>（3）网络基本配置</p>
<blockquote>
<p>root@OpenWrt:~# cat /etc/config/network </p>
<h1 id="Copyright-C-2006-OpenWrt-org"><a href="#Copyright-C-2006-OpenWrt-org" class="headerlink" title="Copyright (C) 2006 OpenWrt.org"></a>Copyright (C) 2006 OpenWrt.org</h1><p>config interface loopback</p>
<pre><code>option ifname   lo

option proto    static

option ipaddr   127.0.0.1

option netmask  255.0.0.0
</code></pre><p>config interface lan</p>
<pre><code>option ifname   eth0

option proto    static

option ipaddr   172.16.5.254

option netmask  255.255.255.0
</code></pre><h2 id="Example-for-ATM-bridging"><a href="#Example-for-ATM-bridging" class="headerlink" title="Example for ATM bridging."></a>Example for ATM bridging.</h2><h2 id="Useful-for-PPPoE-or-IP-over-ATM-Will-create-‘nas-unit-’"><a href="#Useful-for-PPPoE-or-IP-over-ATM-Will-create-‘nas-unit-’" class="headerlink" title="Useful for PPPoE or IP over ATM. Will create ‘nas${unit}’"></a>Useful for PPPoE or IP over ATM. Will create ‘nas${unit}’</h2><p>#</p>
<p>config atm-bridge</p>
<pre><code>option unit     0

option encaps   llc

option vpi      8

option vci      35

option payload  bridged # some ISPs need this set to &apos;routed&apos;
</code></pre><p>config interface wan</p>
<h2 id="PPPoE"><a href="#PPPoE" class="headerlink" title="PPPoE:"></a>PPPoE:</h2><pre><code>option ifname   nas0

option proto    pppoe

option keepalive 10
</code></pre><h2 id="PPPoA"><a href="#PPPoA" class="headerlink" title="PPPoA:"></a>PPPoA:</h2><h1 id="option-ifname-atm0"><a href="#option-ifname-atm0" class="headerlink" title="option ifname   atm0"></a>option ifname   atm0</h1><h1 id="option-proto-pppoa"><a href="#option-proto-pppoa" class="headerlink" title="option proto    pppoa"></a>option proto    pppoa</h1><h1 id="option-encaps-llc"><a href="#option-encaps-llc" class="headerlink" title="option encaps   llc"></a>option encaps   llc</h1><h1 id="option-vpi-8"><a href="#option-vpi-8" class="headerlink" title="option vpi      8"></a>option vpi      8</h1><h1 id="option-vci-35"><a href="#option-vci-35" class="headerlink" title="option vci      35"></a>option vci      35</h1><h2 id="Both"><a href="#Both" class="headerlink" title="Both:"></a>Both:</h2><pre><code>option username &quot;adslname&quot;

option password &quot;adslpasswd&quot;
</code></pre></blockquote>
<p>这是一个很典型的网络配置文件，LAN 我就不解释了。VCI 、VPI请咨询当地的服务提供商（电信）。<br>请注意：<em>option ifname   nas0</em>，如果你没有这个设备，尝试重启服务：</p>
<p><code>/etc/init.d/br2684ctl restart</code></p>
<p>它会替你创建一个 nas0 设备的。</p>
<p>查看网络状况：</p>
<blockquote>
<p>root@OpenWrt:~# ip add show                  </p>
<p>1: lo: <loopback,up,lower_up> mtu 16436 qdisc noqueue state UNKNOWN </loopback,up,lower_up></p>
<pre><code>link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00

inet 127.0.0.1/8 brd 127.255.255.255 scope host lo
</code></pre><p>2: eth0: <broadcast,multicast,up,lower_up> mtu 1500 qdisc pfifo_fast state UP qlen 1000</broadcast,multicast,up,lower_up></p>
<pre><code>link/ether 00:0e:0a:aa:44:ff brd ff:ff:ff:ff:ff:ff

inet 172.16.5.254/24 brd 172.16.5.255 scope global eth0
</code></pre><p>3: nas0: <broadcast,multicast,up,lower_up> mtu 1500 qdisc pfifo_fast state UNKNOWN qlen 1000</broadcast,multicast,up,lower_up></p>
<pre><code>link/ether 00:0e:0a:aa:44:ff brd ff:ff:ff:ff:ff:ff
</code></pre><p>4: ppp0: <pointopoint,multicast,noarp,up,lower_up> mtu 1492 qdisc pfifo_fast state UNKNOWN qlen 3</pointopoint,multicast,noarp,up,lower_up></p>
<pre><code>link/ppp 

inet 116.232.xxx.xxx peer 124.74.0.xxx/32 scope global ppp0
</code></pre></blockquote>
<p>更多的，就请参考 Linux 的试用了。<br>由于我个人需要 pptp，所以提供的 bin 包内包含了：PPTP、IPSEC-Tools、TC 等内容，可以实现的高级功能还是很多的。</p>
<p>由于我有专门负责存储、下载的 miniPC ，所以没有在修改硬件上下功夫。更多的就留给高手来探索了。单纯网络方面的功能， openwrt 已经完全满足我的需要了。</p>
<p>有任何问题，欢迎留言以及来信。</p>
</div></article></div></main><footer><div class="paginator"><a href="/2008/06/openwrt-pptp-howto.html" class="prev">PREV</a><a href="/2008/05/my-chemical-romance.html" class="next">NEXT</a></div><div class="copyright"><p>© 2015 - 2017 <a href="http://latteye.me">latteye</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>