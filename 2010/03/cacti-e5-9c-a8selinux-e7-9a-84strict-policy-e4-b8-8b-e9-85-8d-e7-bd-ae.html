<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> cacti在selinux的strict policy下配置 · Water is</title><meta name="description" content="cacti在selinux的strict policy下配置 - latteye"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://latteye.me/atom.xml" title="Water is"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://www.zhihu.com/people/yuan-hao-yang" target="_blank" class="nav-list-link">ZHIHU</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">cacti在selinux的strict policy下配置</h1><div class="post-info">2010年3月19日</div><div class="post-content"><p>系统： CentOS 5.4<br>内核： 2.6.18-164.el5<br>Selinux： selinux-policy-strict-2.4.6-255.el5<br><a id="more"></a></p>
<p>Selinux比较折腾，特别是在strict policy下</p>
<p>启用strict policy：<br><strong>step 1</strong>. 修改/etc/selinux/config<br>          SELINUX=permissive<br>          SELINUXTYPE=strict<br>          这里一定要先设定到permissive模式，等所有服务调试ok了再改到enforcing<br><strong>step 2</strong>.  touch /.autorelabel<br><strong>step 3</strong>.  reboot</p>
<p>cacti软件的安装不多说了，dag源（<a href="http://dag.wieers.com/rpm/）加入后yum" target="_blank" rel="external">http://dag.wieers.com/rpm/）加入后yum</a> install cacti就可以搞定了。<br>默认安装的cacti在/var/www/cacti，而添加的cacti用户由于selinux策略的原因，是无法访问/var/www，这将导致cacti无法通过poller.php去定时更新数据，因此我这里的做法是将/var/www/cacti下的所有文件移动到cacti的home目录</p>
<p>开始之前先确认是以root登录系统了，而且执行newrole -r sysadm_r切换用户的sysadm身份</p>
<p>下面说一下配置步骤：<br><strong>step 1</strong>. 修改/etc/passwd将cacti目录移至/home/cacti</p>
<p><strong>step 2</strong>. mv /var/www/cacti/*  /home/cacti</p>
<p><strong>step 3</strong>. genhomedircon &amp;&amp; restorecon -R /home/cacti &amp;&amp; chmod 755 /home/cacti<br>         这里设定目录权限755是为apache能访问cacti目录</p>
<p><strong>step 4</strong>. 更新cacti目录下include/config.php:  $database_hostname = “127.0.0.1”;<br>          我这里必须将这个参数设定到127.0.0.1， 不能用localhost，否则要么apache连不到数据库，要么cron里poller.php执行连不到数据库</p>
<p>完成到这一步，就可以将selinux的模式切换到enforcing： setenforce 1</p>
<p><strong>step 5</strong>. 修改apache相关的selinux设定<br>setsebool -P httpd_enable_homedirs 1<br>setsebool -P httpd_can_network_connect_db 1<br>更改完后run_init /etc/init.d/httpd restart重启apache</p>
<p><strong>step 6</strong>. 请确认系统的auditd服务已经起来了，如果还没有，请执行run_init /etc/init.d/auditd start</p>
<p><strong>step 7</strong>. 修改cronjob<br>默认cacti定时更新数据的cron是通过/etc/cron.d/cacti运行的，我这样设定没有成功过，也没发现任何报错，最后只能由cacti用户自己设定。<br>这里要强调一下crontab -e -u user 这种方式在strict模式下不适用，因为这个操作会修改用户的cron文件的security context，导致crond不能成功运行用户的定时任务。</p>
<p><strong>step 8</strong>. 通过audit日志，添加必要的selinux设定<br>cat /var/log/audit/audit.log|aduit2allow -M cacti &amp;&amp; semodule -i cacti.pp</p>
</div></article></div></main><footer><div class="paginator"><a href="/2010/03/postfix-e5-9c-b0-e5-9d-80-e6-9b-bf-e6-8d-a2.html" class="prev">PREV</a><a href="/2010/03/e8-a3-85-e4-bf-ae-e6-97-a5-e8-ae-b0-e7-81-af-e9-a5-b0-e9-80-89-e6-8b-a9.html" class="next">NEXT</a></div><div class="copyright"><p>© 2015 - 2017 <a href="http://latteye.me">latteye</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>