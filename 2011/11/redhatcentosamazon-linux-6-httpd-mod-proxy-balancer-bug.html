<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> RedHat&CentOS&Amazon Linux 6 httpd mod_proxy_balancer bug · Water is</title><meta name="description" content="RedHat&amp;CentOS&amp;Amazon Linux 6 httpd mod_proxy_balancer bug - latteye"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://latteye.me/atom.xml" title="Water is"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="http://weibo.com/sunchongsheng" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/pinggod" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">RedHat&CentOS&Amazon Linux 6 httpd mod_proxy_balancer bug</h1><div class="post-info">2011年11月19日</div><div class="post-content"><p>在 Amazon Linux 上应用 Apache httpd mod_proxy_balancer 模块，后端 tomcat 需要 session，于是使用到了 stickysession 功能，但起初无论如何都无法令其工作。于是再转入 CentOS 6 环境测试，发现效果一样。<a id="more"></a></p>
<p>不工作的配置：</p>
<pre lang="apache"> <virtualhost *:80="">
     ProxyPass / balancer://appCluster/ stickysession=JSESSIONID
     ProxyPassReverse / balancer://appCluster/
 </virtualhost>

 <proxy balancer:="" appcluster="">
     BalancerMember ajp://172.16.5.154:8009 smax=5 route=jvm1 retry=60 ttl=60
     BalancerMember ajp://172.16.5.154:8010 smax=5 route=jvm2 retry=60 ttl=60
 </proxy>
</pre>

<p>工作的配置：</p>
<pre lang="apache"><virtualhost *:80="">
    ProxyPass / balancer://appCluster/
    ProxyPassReverse / balancer://appCluster/
</virtualhost>

<proxy balancer:="" appcluster="">
    BalancerMember ajp://172.16.5.154:8009 smax=5 route=jvm1 retry=60 ttl=60
    BalancerMember ajp://172.16.5.154:8010 smax=5 route=jvm2 retry=60 ttl=60
    ProxySet stickysession=JSESSIONID
</proxy></pre>

<p>按照 <a href="http://httpd.apache.org/docs/2.2/mod/mod_proxy.html#proxyset" title="ProxySet" target="_blank" rel="external">ProxySet</a> 的解释，它也只是到了后面的一种替代配置方式。而按照 <a href="http://httpd.apache.org/docs/2.2/mod/mod_proxy.html#proxypass" title="ProxyPass" target="_blank" rel="external">ProxyPass</a> 的说明，这两种配置方式都应该是工作的。于是我开始做跟进一步的跟踪。</p>
<p>配置 balancer log：</p>
<pre lang="apache">LogFormat "\"%{MYCOOKIE}C\" \"%{Set-Cookie}o\" \"%{BALANCER_SESSION_STICKY}e\" \"%{BALANCER_SESSION_ROUTE}e\" \"%{BALANCER_WORKER_ROUTE}e\" \"%{BALANCER_ROUTE_CHANGED}e\"" session
CustomLog logs/session_log session</pre>

<p>工作的 log：</p>
<pre lang="apache">"-" "-" "-" "-" "jvm1" "1"
"-" "-" "-" "-" "jvm2" "1"
"-" "-" "-" "-" "jvm1" "1"
"-" "JSESSIONID=8B23E43DC6CA0C11BFB14A7D40A3C489.jvm2; Path=/ewallet/; HttpOnly" "-" "-" "jvm2" "1"
"-" "-" "JSESSIONID" "jvm2" "jvm2" "-"
"-" "-" "JSESSIONID" "jvm2" "jvm2" "-"
"-" "-" "JSESSIONID" "jvm2" "jvm2" "-"
"-" "-" "JSESSIONID" "jvm2" "jvm2" "-"</pre>

<p>不工作的 log：</p>
<pre lang="apache">
"-" "JSESSIONID=8277BFA34D8B787722F39251F223A837.jvm1; Path=/ewallet/; HttpOnly" "-" "-" "jvm1" "-"
"-" "-" "-" "-" "jvm2" "-"
"-" "-" "-" "-" "jvm1" "-"
"-" "-" "-" "-" "jvm2" "-"</pre>

<p>给我的感觉是 balancer 模块完全没有意识到需要按照 sessionid 的方式去选择 route。很明显 balancer 模块已经看到 cookie 了。</p>
<p>全局打开 debug 模式，工作的log：</p>
<pre lang="apache">mod_proxy_balancer.c(46): proxy: BALANCER: canonicalising URL //appCluster/ewallet/account
mod_proxy_balancer.c(280): proxy: BALANCER: Found value AAE5BBF643F75BFFE91FA4F7841B3847.jvm1 for stickysession JSESSIONID
mod_proxy_balancer.c(290): proxy: BALANCER: Found route jvm1
mod_proxy_balancer.c(581): proxy: BALANCER (balancer://appcluster) worker (ajp://172.16.5.154:8009) rewritten to ajp://172.16.5.154:8009/ewallet/account</pre>

<p>不工作的 log：</p>
<pre lang="apache">mod_proxy_balancer.c(46): proxy: BALANCER: canonicalising URL //appCluster/ewallet/login.jsp
 mod_proxy_balancer.c(1003): proxy: Entering byrequests for BALANCER (balancer://appcluster)
 mod_proxy_balancer.c(1046): proxy: byrequests selected worker "ajp://172.16.5.154:8009" : busy 0 : lbstatus 0
 mod_proxy_balancer.c(581): proxy: BALANCER (balancer://appcluster) worker (ajp://172.16.5.154:8009) rewritten to ajp://172.16.5.154:8009/ewallet/login.jsp</pre>

<p>基本上可以确定为是一个 bug。然后我去 RedHat bugzilla 搜索了一下，看到一个类似的问题：<a href="https://bugzilla.redhat.com/show_bug.cgi?id=475787" target="_blank" rel="external">mod_proxy_balancer: strange behaviour of multiple session identifiers [NEEDINFO]</a> 。不过原提交人未再给出详细的信息了。</p>
</div></article></div></main><footer><div class="paginator"><a href="/2011/11/keyboard.html" class="prev">PREV</a><a href="/2011/11/pc-low-fi-e4-b9-8b-e8-b7-af-3.html" class="next">NEXT</a></div><div class="copyright"><p>© 2015 - 2017 <a href="http://latteye.me">latteye</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>