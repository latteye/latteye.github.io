<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> MBR & GPT · Water is</title><meta name="description" content="MBR &amp; GPT - latteye"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://latteye.me/atom.xml" title="Water is"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://www.zhihu.com/people/yuan-hao-yang" target="_blank" class="nav-list-link">ZHIHU</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">MBR & GPT</h1><div class="post-info">2011年4月24日</div><div class="post-content"><p>MBR 和 GPT 的问题已经走到了非常现实的阶段-3T硬盘开始普及。MBR 由于对 3T 硬盘寻址无法支持，终于要开始被弃用了。但仅仅只是“开始”，我感觉至少10年之内 MBR 还不会消失。恐怕当GPT适应不了需求的时候，MBR才会消失。<br><a id="more"></a><br><strong>一、MBR 的失误</strong><br>  说“失误”牵强了一点。我们不能要求当年只有5M的硬盘就扣出2M来放寻址信息。计算机永远比你想象的要发展的快。<br>  首先你要有一些基本的硬盘的MBR知识，如果你不熟悉，可以先在 wiki 看一看<a href="http://zh.wikipedia.org/wiki/%E7%A1%AC%E7%9B%98" target="_blank" rel="external">硬盘的基本结构</a>。<br>  在了解了磁道、柱面、扇区之后，再看下面的 MBR 结构就很了然了：</p>
<div align="center"><table width="540" border="1" cellspacing="0" cellpadding="0"><br>  <tr><br>    <td colspan="5"><br>      <div align="center"><font face="Verdana, Arial, Helvetica, sans-serif"><font size="4" face="Arial, Helvetica, sans-serif">基本MBR结构</font></font></div><br>    </td><br>  </tr><br>  <tr><br>    <td colspan="2" align="center"> <strong><font face="Arial, Helvetica, sans-serif">偏移量(位置)<br>      (within sector)<br><br>      </font></strong></td><br><br>    <td rowspan="2" width="85"><br>      <div align="center"><font face="Arial, Helvetica, sans-serif"><strong>长度<br><br>        (in <em>bytes</em>)</strong></font></div><br>    </td><br>    <td rowspan="2"><br>      <div align="center"><font face="Verdana, Arial, Helvetica, sans-serif" size="4"><strong>解释</strong></font></div><br>    </td><br><br>  </tr><br>  <tr><br>    <td width="100"><br>      <div align="center"><strong><font face="Arial, Helvetica, sans-serif"><em>十进制</em></font></strong></div><br>    </td><br>    <td width="100"><br>      <div align="center"><font face="Arial, Helvetica, sans-serif"><strong><em>十六进制</em></strong></font></div><br>    </td><br>  </tr><br><br>  <tr><br>    <td width="100" height="35"><br>      <div align="center"><font face="Courier New, Courier, mono" size="2"><strong>000 - 445</strong></font></div><br>    </td><br>    <td width="100" height="35"><br>      <div align="center"><font face="Courier New, Courier, mono" size="2"><strong>000 - 1BD</strong></font></div><br>    </td><br>    <td width="85" height="35"><br>      <div align="center"><font face="Courier New, Courier, mono"><strong><font size="4">446</font></strong></font></div>

<pre><code>&lt;/td&gt;
&lt;td height=&quot;35&quot;&gt; 
  &lt;div align=&quot;center&quot;&gt;&lt;font face=&quot;Verdana, Arial, Helvetica, sans-serif&quot;&gt;&lt;font size=&quot;4&quot;&gt;引导程序&lt;/font&gt;&lt;/font&gt;&lt;/div&gt;
&lt;/td&gt;
</code></pre><p>  </p></td></tr><br>  <tr><br>    <td width="100" height="35" bgcolor="#CCFFCC"><br>      <div align="center"><font face="Courier New, Courier, mono" size="2"><strong>446 - 509</strong></font></div><br>    </td><p></p>
<pre><code>&lt;td width=&quot;100&quot; height=&quot;35&quot; bgcolor=&quot;#CCFFCC&quot;&gt; 
  &lt;div align=&quot;center&quot;&gt;&lt;font face=&quot;Courier New, Courier, mono&quot; size=&quot;2&quot;&gt;**1BE  - 1FD**&lt;/font&gt;&lt;/div&gt;
&lt;/td&gt;
&lt;td width=&quot;85&quot; height=&quot;35&quot; bgcolor=&quot;#CCFFCC&quot;&gt; 
  &lt;div align=&quot;center&quot;&gt;&lt;font face=&quot;Courier New, Courier, mono&quot; size=&quot;4&quot;&gt;**64**&lt;/font&gt;&lt;/div&gt;
&lt;/td&gt;
&lt;td height=&quot;35&quot; bgcolor=&quot;#CCFFCC&quot;&gt; 
  &lt;div align=&quot;center&quot;&gt;&lt;font size=&quot;4&quot; face=&quot;Verdana, Arial, Helvetica, sans-serif&quot;&gt;_主_分区表&lt;/font&gt;&lt;/div&gt;

&lt;/td&gt;
</code></pre><p>  </p></tr><br>  <tr><br>    <td width="100" height="35"><br>      <div align="center"><font face="Courier New, Courier, mono" size="2"><strong>510 - 511</strong></font></div><br>    </td><br>    <td width="100" height="35"><br>      <div align="center"><font face="Courier New, Courier, mono" size="2"><strong>1FE - 1FF</strong></font></div><br>    </td><p></p>
<pre><code>&lt;td width=&quot;85&quot; height=&quot;35&quot;&gt; 
  &lt;div align=&quot;center&quot;&gt;&lt;font face=&quot;Courier New, Courier, mono&quot; size=&quot;4&quot;&gt;**2**&lt;/font&gt;&lt;/div&gt;
&lt;/td&gt;
&lt;td height=&quot;35&quot;&gt; 
  &lt;div align=&quot;center&quot;&gt;&lt;font size=&quot;3&quot; face=&quot;Verdana, Arial, Helvetica, sans-serif&quot;&gt;**引导记录**&lt;/font&gt;&lt;/div&gt;
&lt;/td&gt;
</code></pre><p>  </p></tr><br></table><font face="Times New Roman, Times, serif" size="3"><strong>表 1.</strong></font></div><p></p>
<p>MBR 永远占用了第一个扇区，通常为512bytes大小。在这512bytes中被MBR本身的程序用去了446bytes。于是，真正描述分区信息的就只有 64 bytes。而根据4个主分区的设计，每一个分区能用到的只有 16bytes. 那么！这16bytes是如何工作的？</p>
<div align="center"><table width="500" border="1" cellspacing="0" cellpadding="2"><br>  <tr><br>    <td colspan="3" bgcolor="#CCFFCC"><br>      <div align="center"><font size="4" face="Arial, Helvetica, sans-serif"><em>16-byte </em>分区表结构</font></div><br>    </td><br>  </tr><br>  <tr><br>    <td align="center"><font face="Arial, Helvetica, sans-serif" size="3"><strong>Relative<br>      Offsets<br><br>      (<em>within entry</em>)</strong></font></td><br>    <td><br>      <div align="center"><font face="Arial, Helvetica, sans-serif" size="3"><strong>长度<br><br>        (<em>bytes</em>)</strong></font></div><br>    </td><br>    <td><br>      <div align="center"><strong><font face="Arial, Helvetica, sans-serif" size="4">内容</font></strong></div><br>    </td><br>  </tr><br>  <tr><br><br>    <td><br>      <div align="right"><font face="Courier New, Courier, mono" size="3"><strong>0&nbsp;</strong></font></div><br>    </td><br>    <td><br>      <div align="center"><font face="Verdana, Arial, Helvetica, sans-serif" size="3"><strong>1</strong></font></div><br>    </td><br>    <td><br>      <div align="center"><font face="Verdana, Arial, Helvetica, sans-serif" size="3"><strong>引导标记 (<font face="Arial, Helvetica, sans-serif">80h = <em>active</em></font>)</strong></font></div>

<pre><code>&lt;/td&gt;
</code></pre><p>  </p></td></tr><br>  <tr bgcolor="#99CCCC"><br>    <td><br>      <div align="right"><font face="Courier New, Courier, mono" size="3"><strong>1 - 3&nbsp;</strong></font></div><br>    </td><br>    <td><br>      <div align="center"><font face="Verdana, Arial, Helvetica, sans-serif" size="3"><strong>3</strong></font></div><br>    </td><p></p>
<pre><code>&lt;td&gt; 
  &lt;div align=&quot;center&quot;&gt;&lt;font face=&quot;Verdana, Arial, Helvetica, sans-serif&quot; size=&quot;3&quot;&gt;**CHS 开始位置**&lt;/font&gt;&lt;/div&gt;
&lt;/td&gt;
</code></pre><p>  </p></tr><br>  <tr><br>    <td><br>      <div align="right"><font face="Courier New, Courier, mono" size="3"><strong>4&nbsp;</strong></font></div><br>    </td><br>    <td><br>      <div align="center"><font face="Verdana, Arial, Helvetica, sans-serif" size="3"><strong>1</strong></font></div><p></p>
<pre><code>&lt;/td&gt;
&lt;td&gt; 
  &lt;div align=&quot;center&quot;&gt;&lt;font face=&quot;Verdana, Arial, Helvetica, sans-serif&quot; size=&quot;3&quot;&gt;**_分区类型_描述**&lt;/font&gt;&lt;/div&gt;
&lt;/td&gt;
</code></pre><p>  </p></td></tr><br>  <tr bgcolor="#99CCCC"><br>    <td><br>      <div align="right"><font face="Courier New, Courier, mono" size="3"><strong>5 - 7&nbsp;</strong></font></div><p></p>
<pre><code>&lt;/td&gt;
&lt;td&gt; 
  &lt;div align=&quot;center&quot;&gt;&lt;font face=&quot;Verdana, Arial, Helvetica, sans-serif&quot; size=&quot;3&quot;&gt;**3**&lt;/font&gt;&lt;/div&gt;
&lt;/td&gt;
&lt;td&gt; 
  &lt;div align=&quot;center&quot;&gt;&lt;font face=&quot;Verdana, Arial, Helvetica, sans-serif&quot;&gt;**CHS 结束位置**&lt;/font&gt;&lt;/div&gt;
&lt;/td&gt;
</code></pre><p>  </p></td></tr><br>  <tr><p></p>
<pre><code>&lt;td&gt; 
  &lt;div align=&quot;right&quot;&gt;&lt;font face=&quot;Courier New, Courier, mono&quot; size=&quot;3&quot;&gt;**8 - 11**&lt;/font&gt;&lt;/div&gt;
&lt;/td&gt;
&lt;td&gt; 
  &lt;div align=&quot;center&quot;&gt;&lt;font face=&quot;Verdana, Arial, Helvetica, sans-serif&quot; size=&quot;3&quot;&gt;**4**&lt;/font&gt;&lt;/div&gt;
&lt;/td&gt;
&lt;td&gt; 
  &lt;div align=&quot;center&quot;&gt;&lt;font face=&quot;Verdana, Arial, Helvetica, sans-serif&quot;&gt;**启始扇区**&lt;/font&gt;&lt;/div&gt;
&lt;/td&gt;
</code></pre><p>  </p></tr><br>  <tr><br>    <td><br>      <div align="right"><font face="Courier New, Courier, mono" size="3"><strong>12 - 15</strong></font></div><br>    </td><br>    <td><br>      <div align="center"><font face="Verdana, Arial, Helvetica, sans-serif" size="3"><strong>4</strong></font></div><br>    </td><br>    <td><br>      <div align="center"><font face="Verdana, Arial, Helvetica, sans-serif" size="3"><strong>分区大小 (扇区单位)</strong></font></div><p></p>
<pre><code>&lt;/td&gt;
</code></pre><p>  </p></td></tr><br></table><font face="Times New Roman, Times, serif" size="3"><strong>表 2.</strong></font></div><p></p>
<p>在表2中，有2个“开始位置”，我们分开理解。<br>硬盘的历史过程中，第一个遇到的问题就是 8G 瓶颈。这就是因为在 <a href="http://zh.wikipedia.org/wiki/CHS" target="_blank" rel="external">CHS</a> 描述方式中，描述起点和终点均为3个 byte。我们假设是 FF FF FF ，所以是 16<em>16</em>16<em>16</em>16<em>16</em>512=8589934592 这就是 8G 瓶颈的由来了。<br>但是今天 CHS 方式几乎已经不用了。后面还有 4 个 bytes 的“启始” 是给 LPA 方式用的。他的极限就是 8589934592 * 256 =2199023255552 这就是 2T 的限制由来了。<br>在硬盘容量的历史中，有很多因素决定了它的限制。BIOS，ATA（IDE），文件系统。<a href="http://baike.baidu.com/view/1329184.html#sub1329184" target="_blank" rel="external">百度上的这篇文章</a>简单的介绍了各个阶段的限制。</p>
<p><strong>二、GPT 的思路</strong></p>
<p>GPT （<a href="http://zh.wikipedia.org/wiki/GUID" target="_blank" rel="external">GUID</a> Partition Table）属于 EFI 方案中的一部分。虽然很早就开始制定这个标准，但到今天，还是有很多系统不支持 GPT。</p>
<p>首先，引用一张wikipedia上的结构图，来了解一下 GPT 的基本结构。<br><img src="http://pic.yupoo.com/latteye/B17xQ3yR/10KRRM.png" alt="GPT"></p>
<p>GPT 为了兼容 MBR，LBA 0 依旧保留了MBR的结构。在GPT工作是，会优先读取 GPT (LBA1) 内容。如果没有 GPT 内容，则认为这是一块MBR磁盘。再从LBA 0 读取MBR。</p>
<p>在硬盘末尾，GPT 备份了一份，这样当GPT出错时，可以快速的从硬盘末尾恢复。LBA -1 (负1) 表示倒数第一块 LBA。</p>
<p>从LBA 2 到 LBA 33 ，一共预留了 128 个分区表空间。 GPT 支持在一块硬盘上创建 128 个分区（真有这种需求？）。所以每一个分区可以使用 128 bytes 的空间。</p>
<p>来看一看 LBA 1 的结构吧，有了 512bytes 的巨型空间，都用不掉了。</p>
<table border="1"><br><br><caption><strong>GPT头的基本结构</strong></caption><br><tr><br><th>起始字节</th><br><th>长度</th><br><th>内容</th><br></tr><br><tr><br><td align="right">0</td><br><td align="right">8字节</td><br><td>签名（”EFI PART”, 45 46 49 20 50 41 52 54）</td><br><br></tr><br><tr><br><td align="right">8</td><br><td align="right">4字节</td><br><td>修订（比如，1.0，值是 00 00 01 00）</td><br></tr><br><tr><br><td align="right">12</td><br><td align="right">4字节</td><br><td>分区表头的大小（单位是字节，通常是92字节，即 5C 00 00 00）</td><br></tr><br><br><tr><br><td align="right">16</td><br><td align="right">4字节</td><br><td>分区表头前3项（第0－15字节）的<a href="http://zh.wikipedia.org/wiki/CRC32" title="CRC32" target="_blank" rel="external">CRC32</a>校验，如果值正在计算，则是 0</td><br></tr><br><tr><br><td align="right">20</td><br><td align="right">4字节</td><br><td>保留，必须是 0</td><br><br></tr><br><tr><br><td align="right">24</td><br><td align="right">8字节</td><br><td>当前LBA（这个分区表头的位置）</td><br></tr><br><tr><br><td align="right">32</td><br><td align="right">8字节</td><br><td>备份LBA（备份分区表头的位置）</td><br></tr><br><br><tr><br><td align="right">40</td><br><td align="right">8字节</td><br><td>第一个可用于分区的LBA（主分区表的最后一个LBA + 1）</td><br></tr><br><tr><br><td align="right">48</td><br><td align="right">8字节</td><br><td>最后一个可用于分区的LBA（备份分区表的最后一个LBA − 1）</td><br></tr><br><tr><br><br><td align="right">56</td><br><td align="right">16字节</td><br><td>硬盘GUID（在<a href="http://zh.wikipedia.org/wiki/%E9%A1%9EUNIX" title="类UNIX" target="_blank" rel="external">类UNIX</a>系统中也叫<a href="http://zh.wikipedia.org/wiki/UUID" target="_blank" rel="external">UUID</a>）</td><br></tr><br><tr><br><td align="right">72</td><br><td align="right">8字节</td><br><td>分区表项的起始LBA（对于主分区表来说，这个值是 LBA 2）</td><br><br></tr><br><tr><br><td align="right">80</td><br><td align="right">4字节</td><br><td>分区表的数量</td><br></tr><br><tr><br><td align="right">84</td><br><td align="right">4字节</td><br><td>一个分区表的大小（通常是128）</td><br></tr><br><br><tr><br><td align="right">88</td><br><td align="right">4字节</td><br><td>分区串行的CRC32校验</td><br></tr><br><tr><br><td align="right">92</td><br><td align="center">*</td><br><td>保留，剩余的字节必须是0（对于512字节LBA的硬盘即是420个字节）</td><br></tr><br></table>

<p>此表来源为 <a href="http://zh.wikipedia.org/wiki/%E5%85%A8%E5%B1%80%E5%94%AF%E4%B8%80%E6%A8%99%E8%AD%98%E5%88%86%E5%8D%80%E8%A1%A8" target="_blank" rel="external">中文 Wikipedia</a>, 稍微修改了两个字，便于理解。</p>
<p>通过这张表，程序可以获知分区数量，第一个分区在哪个位置，以及GPT头是否正确（CRC32）。在这里着重解决的是分数数量问题，以及分区表的安全性问题。而分区的大小问题，则依赖了 GPT 的分区表：</p>
<table border="1"><br><caption><strong>GPT分区表项的格式</strong></caption><br><tr><br><th>起始字节</th><br><th>长度</th><br><th>内容</th><br></tr><br><tr><br><td align="right">0</td><br><td align="right">16字节</td><br><td>分区类型GUID</td><br><br></tr><br><tr><br><td align="right">16</td><br><td align="right">16字节</td><br><td>分区GUID</td><br></tr><br><tr><br><td align="right">32</td><br><td align="right">8字节</td><br><td>起始LBA（<a href="http://zh.wikipedia.org/wiki/%E5%B0%8F%E7%AB%AF%E5%BA%8F" title="小端序" target="_blank" rel="external">小端序</a>）</td><br><br></tr><br><tr><br><td align="right">40</td><br><td align="right">8字节</td><br><td>末尾LBA</td><br></tr><br><tr><br><td align="right">48</td><br><td align="right">8字节</td><br><td>属性标签（如：<code>60</code>表示“只读”）</td><br><br></tr><br><tr><br><td align="right">56</td><br><td align="right">72字节</td><br><td>分区名（可以包括36个<a href="http://zh.wikipedia.org/wiki/UTF-16" target="_blank" rel="external">UTF-16</a>（小端序）字符）</td><br></tr><br></table>

<p>重点就在这里了，在描述分区位置的时候，使用了8个字节，其最大值为 FF FF FF FF FF FF FF FF 。那么，假设每一个LBA 为512 bytes。其能描述的大小为 8589934592 TB = 8 ZB 。关于这个数字我算下来的确是在 ZB 级别的。但是搜索到的文章说法不一：</p>
<blockquote>
<p><a href="http://tech.sina.com.cn/h/2011-04-12/05441713987.shtml" target="_blank" rel="external">突破2TB限制 3TB硬盘装操作系统实战</a> 9.4ZB （GPT分区表采用8个字节即64bit来存储扇区数，因此它最大可支持264个扇区。）</p>
<p><a href="http://social.microsoft.com/Forums/zh-CN/windowsserversystemzhchs/thread/413073fd-b169-44a2-9dbb-5648d8e03c07" target="_blank" rel="external">关于windows server 2003最大支持硬盘容量的问题</a>  18EB</p>
</blockquote>
<p>对于上面这些数字，18EB 恐怕是 LBA 数量，忘记乘 512 bytes 了。9.4ZB 暂时不知道是怎么来的。但这个数字暂且不做定论。因为<a href="http://msdn.microsoft.com/en-us/windows/hardware/gg463525.aspx" target="_blank" rel="external">微软的 FAQ</a> 也提到了，这只是理论值，谁知道下一个瓶颈在哪里呢。</p>
<blockquote>
<p>Q.    How big can a GPT disk be?</p>
<p>A.    In theory, a GPT disk can be up to 2^64 logical blocks in length. Logical blocks are commonly 512 bytes in size.</p>
<p>The maximum partition (and disk) size is a function of the operating system version. Windows XP and the original release of Windows Server 2003 have a limit of 2TB per physical disk, including all partitions. For Windows Server 2003 SP1, Windows XP x64 edition, and later versions, the maximum raw partition of 18 exabytes can be supported. (Windows file systems currently are limited to 256 terabytes each.)</p>
</blockquote>
<p>如有错误，欢迎留言、来信指正！<br><img src="http://latteye.com/gmail.png" alt="Mail"></p>
</div></article></div></main><footer><div class="paginator"><a href="/2011/05/wish-list.html" class="prev">PREV</a><a href="/2011/03/astyle-1-0.html" class="next">NEXT</a></div><div class="copyright"><p>© 2015 - 2017 <a href="http://latteye.me">latteye</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>